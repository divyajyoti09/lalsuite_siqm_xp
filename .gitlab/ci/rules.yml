# ----------------------------------------------------------------------
# LALSuite: CI rules
#
# Rules for CI pipelines, and for skipping/including CI jobs.
# ----------------------------------------------------------------------

workflow:
  rules:
    # run all other pipelines
    - when: always

# -- CI pipelines

# CI build for normal pushes
.ci-push-build:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'

# CI build for merge requests
.ci-merge-build:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "web"'

# CI build for tags on the upstream repo
.ci-tag-build:
  rules:
    - if: '$CI_PROJECT_PATH == "lscsoft/lalsuite" && $CI_COMMIT_TAG'

# CI build for "lalsuite" tags on the upstream repo
.ci-lalsuite-tag-build:
  rules:
    - if: '$CI_PROJECT_PATH == "lscsoft/lalsuite" && $CI_COMMIT_TAG =~ /^lalsuite-v/'

# CI nightly deployment from default branch of the upstream repo
.ci-nightly-deploy:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_PROJECT_PATH == "lscsoft/lalsuite" && $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH'
      variables:
        ENABLE_NIGHTLY: "--enable-nightly"

# -- include CI jobs using commit message

.ci-compiler:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[ci compiler\]/'
      when: always

.ci-conda:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[ci conda\]/'
      when: always

.ci-coverage:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[ci coverage\]/'
      when: always

.ci-debian:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[ci debian\]/'
      when: always

.ci-docs:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[ci docs\]/'
      when: always

.ci-docker:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[ci docker\]/'
      when: always

.ci-integration:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[ci integration\]/'
      when: always

.ci-koji:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[ci koji\]/'
      when: always

.ci-lint:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[ci lint\]/'
      when: always

.ci-platform:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[ci platform\]/'
      when: always

.ci-pkg:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[ci pkg\]/'
      when: always

.ci-rhel:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[ci rhel\]/'
      when: always

.ci-wheels:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[ci wheels\]/'
      when: always
