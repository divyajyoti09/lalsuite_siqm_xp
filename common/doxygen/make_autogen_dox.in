#!/usr/bin/env perl
# Author: Karl Wette, 2023

use strict;

my $package = "@PACKAGE@";
my $markdown2html = "@MARKDOWN2HTML@";

sub markdown_to_html {
  my ($file) = @_;
  die "$0: $file does not exist" unless -f $file;
  my $doxyblock = ($markdown2html eq "cat") ? "verbatim" : "htmlonly";
  print "\\${doxyblock}\n";
  system("$markdown2html $file") == 0 or die "$0: $markdown2html $file failed";
  print "\\end${doxyblock}\n";
}

print <<EOF;
/* Generated by make_autogen_dox */
EOF

# generate main page
print <<EOF;

/** \\mainpage

EOF
markdown_to_html("in/README.md");
print <<EOF;
\\htmlonly
<h2>License</h2>
\\endhtmlonly
\\verbinclude COPYING
*/
EOF

## generate contributing page
if (-f "in/CONTRIBUTING.md") {
  print <<EOF;

/** \\page ${package}_contributing Contributing Guide

EOF
  markdown_to_html("in/CONTRIBUTING.md");
  print <<EOF;

*/
EOF
}

## generate authors page
if (-f "in/AUTHORS") {
  print <<EOF;

/** \\page ${package}_authors Author List

EOF
  open AUTHORS, "in/AUTHORS" or die "$0: could not open in/AUTHORS: $!";
  while (<AUTHORS>) {
    s/^/- /;
    print;
  }
  close AUTHORS;
  print <<EOF;

*/
EOF
}
